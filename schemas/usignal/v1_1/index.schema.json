{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://afi-protocol.org/schemas/usignal/v1.1/index.schema.json",
  "title": "AFI Universal Signal Schema - Root (v1.1 Runtime Canon)",
  "description": "Runtime canonical schema for AFI Universal Signals with mandatory providerId and signalId for audit and reward attribution. This is the living canon for runtime ingestion.",
  "type": "object",
  "required": [
    "schema",
    "provenance"
  ],
  "properties": {
    "schema": {
      "type": "string",
      "const": "afi.usignal.v1.1",
      "description": "Schema version identifier for runtime canon v1.1"
    },
    "lens": {
      "type": "string",
      "description": "Optional lens type identifier. If omitted, intake will auto-detect or treat as generic.",
      "enum": [
        "equity",
        "strategy",
        "macro",
        "onchain"
      ]
    },
    "core": {
      "$ref": "core.schema.json",
      "description": "Core universal signal fields (cross-cutting)"
    },
    "facts": {
      "type": "object",
      "description": "Ingest facts block - replay-canonical market/strategy metadata populated at ingest time and persisted in TSSD vault for deterministic replay",
      "properties": {
        "symbol": {
          "type": "string",
          "description": "Trading symbol (e.g., 'BTC/USDT')"
        },
        "market": {
          "type": "string",
          "description": "Market type (e.g., 'perp', 'spot')"
        },
        "timeframe": {
          "type": "string",
          "description": "Timeframe (e.g., '4h', '1d')"
        },
        "strategy": {
          "type": "string",
          "description": "Strategy identifier (e.g., 'froggy_trend_pullback_v1')"
        },
        "direction": {
          "type": "string",
          "enum": ["long", "short", "neutral"],
          "description": "Signal direction"
        }
      },
      "additionalProperties": false
    },
    "equity": {
      "description": "Equity/credit lens data (when lens=equity)",
      "type": "object",
      "properties": {
        "entity": {
          "type": "object",
          "properties": {
            "ticker": {
              "type": "string"
            },
            "asOf": {
              "type": "string"
            }
          },
          "additionalProperties": true
        },
        "deltaFCF": {
          "type": "object",
          "properties": {
            "drivers": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "delta": {
                    "type": "number"
                  }
                },
                "required": [
                  "name",
                  "delta"
                ],
                "additionalProperties": false
              }
            },
            "reinvestment": {
              "type": "object",
              "properties": {
                "roiicIntangible": {
                  "type": "number"
                },
                "salesToCapital": {
                  "type": "number"
                }
              },
              "additionalProperties": false
            },
            "frictions": {
              "type": "object",
              "properties": {
                "taxRate": {
                  "type": "number"
                }
              },
              "additionalProperties": true
            },
            "capacityConstraints": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          },
          "additionalProperties": true
        },
        "scenarios": {
          "type": "object"
        },
        "terminal": {
          "type": "object",
          "properties": {
            "method": {
              "type": "string"
            },
            "g_stable": {
              "type": "number"
            },
            "wacc": {
              "type": "number"
            }
          },
          "additionalProperties": false
        },
        "statementsReconciled": {
          "type": "boolean"
        }
      },
      "additionalProperties": true
    },
    "strategy": {
      "description": "Strategy lens data (when lens=strategy)",
      "type": "object",
      "properties": {
        "asset": {
          "type": "string"
        },
        "pnlAfterFrictions": {
          "type": "number"
        },
        "frictions": {
          "type": "object",
          "properties": {
            "hedgingCosts": {
              "type": "number"
            },
            "fundingCosts": {
              "type": "number"
            }
          },
          "additionalProperties": true
        },
        "capacity": {
          "type": "object",
          "properties": {
            "maxNotional": {
              "type": "number"
            },
            "slippageAtSizeBps": {
              "type": "number"
            }
          },
          "additionalProperties": true
        },
        "notes": {
          "type": "string"
        }
      },
      "additionalProperties": true
    },
    "macro": {
      "description": "Macro lens data (when lens=macro)",
      "type": "object",
      "properties": {
        "regimeTag": {
          "type": "string"
        },
        "factorAttribution": {
          "type": "array",
          "items": {
            "type": "object"
          }
        },
        "financingRate": {
          "type": "number"
        }
      },
      "additionalProperties": true
    },
    "onchain": {
      "description": "On-chain microstructure lens data (when lens=onchain)",
      "type": "object",
      "properties": {
        "mevCost": {
          "type": "number"
        },
        "gasCost": {
          "type": "number"
        },
        "poolDepthAt1pct": {
          "type": "number"
        },
        "oracleLatencyMs": {
          "type": "number"
        },
        "privateOrderflowAccess": {
          "type": "boolean"
        }
      },
      "additionalProperties": true
    },
    "provenance": {
      "type": "object",
      "description": "Signal provenance and lineage - RUNTIME CANON v1.1 requires providerId and signalId",
      "required": [
        "source",
        "providerId",
        "signalId"
      ],
      "properties": {
        "source": {
          "type": "string",
          "description": "Signal source identifier (e.g., 'tradingview-webhook', 'manual', 'bot')"
        },
        "providerId": {
          "type": "string",
          "description": "Stable identifier for the signal producer/scout (required for reward attribution)"
        },
        "signalId": {
          "type": "string",
          "description": "Stable unique identifier for this signal (required for audit and deduplication)"
        },
        "ingestedAt": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when signal was ingested by AFI reactor"
        },
        "ingestHash": {
          "type": "string",
          "description": "SHA256 hash of raw payload or canonicalized payload for integrity verification"
        },
        "providerType": {
          "type": "string",
          "description": "Provider type classification",
          "enum": ["tradingview", "manual", "bot", "mcp", "api", "other"]
        },
        "providerRef": {
          "type": "string",
          "description": "Free-form provider reference (handle, address, API key ID, etc.)"
        },
        "datasetId": {
          "type": "string",
          "description": "Source dataset identifier (legacy field from v1)"
        },
        "codeCommit": {
          "type": "string",
          "description": "Code commit hash that generated this signal (legacy field from v1)"
        },
        "seed": {
          "description": "Random seed for reproducibility (legacy field from v1)",
          "oneOf": [
            { "type": "string" },
            { "type": "number" },
            { "type": "null" }
          ]
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Signal generation timestamp (ISO 8601) - legacy field from v1, prefer ingestedAt"
        }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": true
}

